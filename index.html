<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¸”ë ˆìŠ¤ ì¹˜ê³¼ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(to bottom right, #eff6ff, #e0f2fe, #ccfbf1);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(to right, #2563eb, #06b6d4, #14b8a6);
      color: white;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 2.25rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      white-space: nowrap;
    }

    .header-subtitle {
      color: #bfdbfe;
      font-size: 1.125rem;
      white-space: nowrap;
    }

    .header-stats {
      text-align: right;
    }

    .header-stats-label {
      font-size: 0.875rem;
      color: #bfdbfe;
      margin-bottom: 0.25rem;
      white-space: nowrap;
    }

    .header-stats-number {
      font-size: 1.875rem;
      font-weight: bold;
      margin-bottom: 0.75rem;
      white-space: nowrap;
    }

    .header-stats-detail {
      font-size: 0.875rem;
      color: #bfdbfe;
      white-space: nowrap;
    }

    .auth-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .auth-box {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      margin: 1rem;
    }

    .auth-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1e293b;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .auth-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      outline: none;
    }

    .auth-input:focus {
      border-color: #3b82f6;
    }

    .auth-button {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(to right, #2563eb, #06b6d4);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-button:hover {
      opacity: 0.9;
    }

    .auth-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      display: none;
    }

    .auth-status {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }

    .auth-status-text {
      font-size: 0.875rem;
      color: #bfdbfe;
    }

    .auth-logout-btn {
      padding: 0.375rem 0.75rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .hidden {
      display: none;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .search-box {
      margin-bottom: 2rem;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 3rem;
      border-radius: 1rem;
      border: 2px solid #e2e8f0;
      font-size: 1rem;
      outline: none;
    }

    .search-input:focus {
      border-color: #3b82f6;
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }

    .section {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      overflow: visible;
    }

    .section-header {
      padding: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 1.5rem 1.5rem 0 0;
    }

    .section-header.lab {
      background: linear-gradient(to right, #3b82f6, #60a5fa);
    }

    .section-header.implant {
      background: linear-gradient(to right, #14b8a6, #10b981);
    }

    .section-title {
      color: white;
      font-size: 1.5rem;
      font-weight: bold;
      white-space: nowrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .btn-add {
      background: white;
      color: #3b82f6;
    }

    .btn-add:hover {
      background: #eff6ff;
    }

    .btn-add.implant {
      color: #14b8a6;
    }

    .btn-add.implant:hover {
      background: #f0fdfa;
    }

    .form-section {
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
    }

    .form-grid {
      display: grid;
      gap: 1rem;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-input {
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 2px solid #cbd5e1;
      outline: none;
      width: 100%;
    }

    .form-input:focus {
      border-color: #3b82f6;
    }

    .btn-submit {
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: none;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }

    .btn-submit:hover {
      background: #2563eb;
    }

    .btn-submit.implant {
      background: #14b8a6;
    }

    .btn-submit.implant:hover {
      background: #0d9488;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 20;
    }

    thead tr {
      color: white;
    }

    thead.lab {
      background: linear-gradient(to right, #3b82f6, #06b6d4);
    }

    thead.implant {
      background: linear-gradient(to right, #14b8a6, #10b981);
    }

    th {
      padding: 1rem 1.5rem;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }

    thead.lab th {
      background: linear-gradient(to right, #3b82f6, #06b6d4);
    }

    thead.implant th {
      background: linear-gradient(to right, #14b8a6, #10b981);
    }

    th.center {
      text-align: center;
    }

    tbody tr {
      border-bottom: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    tbody tr.implant:hover {
      background: rgba(20, 184, 166, 0.05);
    }

    tbody tr.group-header:hover {
      opacity: 0.8;
    }

    tbody tr.completed {
      background: rgba(16, 185, 129, 0.1);
      opacity: 0.6;
    }

    /* ì„í”Œë€íŠ¸ í…Œì´ë¸” ì¶•ì†Œ ìŠ¤íƒ€ì¼ */
    .implant-table td,
    .implant-table th {
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
    }

    .implant-table input[type="text"],
    .implant-table input[type="date"] {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }

    .implant-table .status-badge {
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
    }

    .implant-table .status-select {
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
    }

    .implant-table .status-container {
      gap: 0.25rem;
    }

    .implant-table td:first-child {
      font-size: 0.88rem;
    }

    /* ë‚ ì§œ í•„ë“œì˜ ê´„í˜¸ì™€ ìš”ì¼ í‘œì‹œ ìˆ¨ê¸°ê¸° */
    input[type="date"]::-webkit-datetime-edit-text {
      display: none;
    }

    /* ë¹ˆ ë‚ ì§œ í•„ë“œì˜ ë‚´ìš© ìˆ¨ê¸°ê¸° */
    input[type="date"]:not(.has-value)::-webkit-datetime-edit {
      color: transparent;
    }

    input[type="date"].has-value::-webkit-datetime-edit,
    input[type="date"]:focus::-webkit-datetime-edit,
    input[type="date"]:hover::-webkit-datetime-edit {
      color: inherit;
    }

    .implant-table .group-header td {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    td {
      padding: 1rem 1.5rem;
      white-space: nowrap;
    }

    td input[type="text"],
    td input[type="date"] {
      width: 100%;
      padding: 0.375rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid transparent;
      background: transparent;
      outline: none;
      transition: all 0.2s ease;
    }

    td input[type="text"]:hover,
    td input[type="date"]:hover {
      background: white;
      border-color: #cbd5e1;
    }

    td input[type="text"]:focus,
    td input[type="date"]:focus {
      background: white;
      border-color: #3b82f6;
    }

    td input[type="text"].bold {
      font-weight: bold;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      color: white;
      font-weight: bold;
      font-size: 0.875rem;
    }

    .status-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .status-remove {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      opacity: 0.8;
      padding: 0;
      display: flex;
      align-items: center;
    }

    .status-remove:hover {
      opacity: 1;
    }

    .status-select {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      border: 2px dashed #cbd5e1;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      background: white;
    }

    input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      accent-color: #10b981;
    }

    .btn-delete {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 0;
    }

    .btn-delete:hover {
      color: #dc2626;
    }

    .hidden {
      display: none !important;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 400px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: #1e293b;
    }

    .modal-message {
      color: #64748b;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-btn-cancel {
      background: #e2e8f0;
      color: #475569;
    }

    .modal-btn-cancel:hover {
      background: #cbd5e1;
    }

    .modal-btn-confirm {
      background: #ef4444;
      color: white;
    }

    .modal-btn-confirm:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="authModal" class="auth-container hidden">
    <div class="auth-box">
      <h2 class="auth-title">ğŸ” ë¡œê·¸ì¸</h2>
      <div id="authError" class="auth-error"></div>
      <input type="email" id="authEmail" class="auth-input" placeholder="ì´ë©”ì¼" autocomplete="email">
      <input type="password" id="authPassword" class="auth-input" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
      <button onclick="login()" class="auth-button">ë¡œê·¸ì¸</button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal hidden" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title">ë°ì´í„° ì´ˆê¸°í™”</div>
      <div class="modal-message">
        ì •ë§ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
        ê¸°ê³µì†Œ ë°ì´í„°ëŠ” ì‚­ì œë˜ê³ , ì„í”Œë€íŠ¸ ë°ì´í„°ëŠ” ì´ˆê¸° 32ëª…ì˜ í™˜ì ë°ì´í„°ë¡œ ë³µì›ë©ë‹ˆë‹¤.
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="modal-btn modal-btn-confirm" onclick="confirmReset()">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div id="successMessage" class="modal hidden" onclick="closeSuccessMessage()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title">âœ… ì™„ë£Œ</div>
      <div class="modal-message">ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeSuccessMessage()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Lab Removal Confirmation -->
  <div id="labRemovalModal" class="modal hidden" onclick="closeLabRemovalModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title">ê¸°ê³µì†Œ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œ</div>
      <div class="modal-message" id="labRemovalMessage"></div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeLabRemovalModal()">ì·¨ì†Œ</button>
        <button class="modal-btn modal-btn-confirm" onclick="confirmLabRemoval()">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div>
        <h1>ë¸”ë ˆìŠ¤ ì¹˜ê³¼ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        <div class="header-subtitle">í™˜ì ëª°ì… ë³´ë“œ</div>
      </div>
      <div class="header-stats">
        <div id="authStatus" class="auth-status hidden">
          <span class="auth-status-text">ğŸ‘¤ <span id="userEmail"></span></span>
          <button onclick="logout()" class="auth-logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div id="loginButton" class="auth-status hidden">
          <button onclick="showLoginModal()" class="auth-logout-btn" style="background: rgba(255,255,255,0.3);">ğŸ” ë¡œê·¸ì¸</button>
        </div>
        <div class="header-stats-label">ì´ í™˜ì</div>
        <div class="header-stats-number" id="totalPatients">0</div>
        <div class="header-stats-detail">
          <div>ğŸ”¬ ê¸°ê³µì†Œ: <span id="labCount">0</span>ëª…</div>
          <div>ğŸ¦· í™˜ì: <span id="implantCount">0</span>ëª…</div>
        </div>
        <button onclick="resetData()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; white-space: nowrap;">
          ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Search -->
    <div class="search-box">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" class="search-input" id="searchInput" placeholder="í™˜ìëª… ë˜ëŠ” ì‘ì—…ë‚´ìš© ê²€ìƒ‰...">
    </div>

    <!-- ê¸°ê³µì†Œ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-header lab">
        <div class="section-title">ğŸ”¬ ê¸°ê³µì†Œ ì‘ì—… í˜„í™© (<span id="labFilteredCount">0</span>)</div>
        <button class="btn btn-add" onclick="toggleLabForm()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          ì‹ ê·œ ë“±ë¡
        </button>
      </div>

      <div id="labForm" class="form-section hidden">
        <div class="form-grid">
          <input type="text" class="form-input" id="labName" placeholder="í™˜ìëª… (í•„ìˆ˜)" required>
          <input type="text" class="form-input" id="labWork" placeholder="ì‘ì—…ë‚´ìš© (í•„ìˆ˜)" required>
          <div class="form-grid-2">
            <input type="date" class="form-input" id="labReceiveDate">
            <input type="date" class="form-input" id="labDeadline">
          </div>
          <button class="btn-submit" onclick="addLabPatient()">ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>

      <div>
        <table>
          <thead class="lab">
            <tr>
              <th>í™˜ìëª…</th>
              <th>ì‘ì—…ë‚´ìš©</th>
              <th>ì ‘ìˆ˜ë‚ ì§œ</th>
              <th>ë§ˆê°ê¸°í•œ</th>
              <th class="center">ë‚¨ì€ì¼ìˆ˜</th>
              <th class="center">ì™„ë£Œ</th>
              <th class="center">ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="labTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ì„í”Œë€íŠ¸ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-header implant">
        <div class="section-title">ğŸ¦· í™˜ì í˜„í™© (<span id="implantFilteredCount">0</span>)</div>
        <button class="btn btn-add implant" onclick="toggleImplantForm()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          ì‹ ê·œ ë“±ë¡
        </button>
      </div>

      <div id="implantForm" class="form-section hidden">
        <div class="form-grid">
          <input type="text" class="form-input" id="implantName" placeholder="í™˜ìëª… (í•„ìˆ˜)" required>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; color: #64748b; font-size: 0.875rem; font-weight: 600;">ì´ˆê¸° ìƒíƒœ (ì„ íƒì‚¬í•­)</label>
            <div id="implantFormStatuses" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;"></div>
            <select class="form-input" id="implantFormStatusSelect" onchange="addFormStatus(this.value); this.value = '';">
              <option value="">ìƒíƒœ ì„ íƒ...</option>
              <option value="ë¬¸ì œ">ë¬¸ì œ</option>
              <option value="ê³ ë ¤(ì•½ì†ì—†ìŒ)">ê³ ë ¤(ì•½ì†ì—†ìŒ)</option>
              <option value="ì¶”ê°€ì—°ë½">ì¶”ê°€ì—°ë½</option>
              <option value="ê³ ë ¤(ì•½ì†ìˆìŒ)">ê³ ë ¤(ì•½ì†ìˆìŒ)</option>
              <option value="ìˆ˜ìˆ ì˜ˆì •">ìˆ˜ìˆ ì˜ˆì •</option>
              <option value="ë³´ì² ì˜ˆì •">ë³´ì² ì˜ˆì •</option>
              <option value="ë³´ì²  ì¥ì°©">ë³´ì²  ì¥ì°©</option>
              <option value="ë³´ì¡´">ë³´ì¡´</option>
              <option value="ì—”ë„">ì—”ë„</option>
              <option value="í˜ë¦¬ì˜¤">í˜ë¦¬ì˜¤</option>
              <option value="í¬ë¼ìš´">í¬ë¼ìš´</option>
              <option value="ê¸°ê³µì†Œ">ê¸°ê³µì†Œ</option>
              <option value="ì™„ë£Œ">ì™„ë£Œ</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.25rem; color: #64748b; font-size: 0.875rem;">ì½”ë©˜íŠ¸</label>
            <input type="text" class="form-input" id="implantComment" placeholder="">
          </div>
          <div class="form-grid-2">
            <div>
              <label style="display: block; margin-bottom: 0.25rem; color: #64748b; font-size: 0.875rem;">ë°œì¹˜ë‚ ì§œ</label>
              <input type="date" class="form-input" id="implantExtractionDate">
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.25rem; color: #64748b; font-size: 0.875rem;">ìˆ˜ìˆ ë‚ ì§œ</label>
              <input type="date" class="form-input" id="implantSurgeryDate">
            </div>
          </div>
          <button class="btn-submit implant" onclick="addImplantPatient()">ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>

      <div>
        <table class="implant-table">
          <thead class="implant">
            <tr>
              <th>í™˜ìëª…</th>
              <th>ìƒíƒœ</th>
              <th>ì½”ë©˜íŠ¸</th>
              <th>ë°œì¹˜ë‚ ì§œ</th>
              <th>ìˆ˜ìˆ ë‚ ì§œ</th>
              <th class="center">ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="implantTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // ë°ì´í„° ì €ì¥ì†Œ
    let labPatients = [];
    let implantPatients = [];
    let searchTerm = '';
    let formStatuses = []; // í¼ì—ì„œ ì„ íƒëœ ìƒíƒœë“¤
    let collapsedGroups = {}; // ì ‘íŒ ê·¸ë£¹ ìƒíƒœ ì €ì¥
    let useFirebase = false; // Firebase ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€
    let database = null;
    let auth = null;
    let currentUser = null;

    const statusColors = {
      'ë¬¸ì œ': '#ef4444',
      'ê³ ë ¤(ì•½ì†ì—†ìŒ)': '#fbbf24',
      'ì¶”ê°€ì—°ë½': '#f59e0b',
      'ê³ ë ¤(ì•½ì†ìˆìŒ)': '#f59e0b',
      'ìˆ˜ìˆ ì˜ˆì •': '#06b6d4',
      'ë³´ì² ì˜ˆì •': '#8b5cf6',
      'ë³´ì²  ì¥ì°©': '#a78bfa',
      'ë³´ì¡´': '#f97316',
      'ì—”ë„': '#eab308',
      'í˜ë¦¬ì˜¤': '#22c55e',
      'í¬ë¼ìš´': '#6366f1',
      'ê¸°ê³µì†Œ': '#14b8a6',
      'ì™„ë£Œ': '#10b981'
    };

    const statusOptions = ['ë¬¸ì œ', 'ê³ ë ¤(ì•½ì†ì—†ìŒ)', 'ì¶”ê°€ì—°ë½', 'ê³ ë ¤(ì•½ì†ìˆìŒ)', 'ìˆ˜ìˆ ì˜ˆì •', 'ë³´ì² ì˜ˆì •', 'ë³´ì²  ì¥ì°©', 'ë³´ì¡´', 'ì—”ë„', 'í˜ë¦¬ì˜¤', 'í¬ë¼ìš´', 'ê¸°ê³µì†Œ', 'ì™„ë£Œ'];

    // ì´ˆê¸° ë°ì´í„°
    const initialImplantData = [
      {"name":"ì •ê²½í˜„","statuses":["ë³´ì² ì˜ˆì •","ê¸°ê³µì†Œ"],"extractionDate":"","surgeryDate":"2026-02-09","comment":"","id":1770547080074,"completed":false},
      {"name":"ê¹€ë„ê³„","statuses":["ë¬¸ì œ"],"extractionDate":"2024-06-21","surgeryDate":"2024-06-21","comment":"","id":1770547615013,"completed":false},
      {"name":"ê¹€ì€ì§€","statuses":["ë¬¸ì œ"],"extractionDate":"2025-10-04","surgeryDate":"","comment":"","id":1770547644737,"completed":false},
      {"name":"ë°©í˜„","statuses":["ë¬¸ì œ","ìˆ˜ìˆ ì˜ˆì •"],"extractionDate":"2025-10-13","surgeryDate":"","comment":"","id":1770547839459,"completed":false},
      {"name":"ì‹ ë¯¸í–¥","statuses":["ë¬¸ì œ","ìˆ˜ìˆ ì˜ˆì •"],"extractionDate":"2025-10-29","surgeryDate":"","comment":"","id":1770547877088,"completed":false},
      {"name":"ì•ˆì§„í˜¸","statuses":["ë¬¸ì œ","ìˆ˜ìˆ ì˜ˆì •","ë³´ì² ì˜ˆì •"],"extractionDate":"2026-01-12","surgeryDate":"2026-01-12","comment":"","id":1770547895899,"completed":false},
      {"name":"ì´ì„ ì„","statuses":["ë¬¸ì œ","ìˆ˜ìˆ ì˜ˆì •"],"extractionDate":"2026-02-02","surgeryDate":"","comment":"","id":1770547912070,"completed":false},
      {"name":"ì •ì€ì£¼","statuses":["ë¬¸ì œ","ìˆ˜ìˆ ì˜ˆì •"],"extractionDate":"2026-02-03","surgeryDate":"","comment":"","id":1770547931060,"completed":false},
      {"name":"ì¡°ìˆœì˜","statuses":["ë¬¸ì œ"],"extractionDate":"","surgeryDate":"","comment":"","id":1770547947272,"completed":false},
      {"name":"í™©ì„¸ìš©","statuses":["ë¬¸ì œ"],"extractionDate":"","surgeryDate":"","comment":"","id":1770547959123,"completed":false},
      {"name":"ì†ì˜ì›","statuses":["ê³ ë ¤(ì•½ì†ìˆìŒ)"],"extractionDate":"","surgeryDate":"","comment":"","id":1770547973080,"completed":false},
      {"name":"ì†ìš°í˜•","statuses":["ê³ ë ¤(ì•½ì†ìˆìŒ)"],"extractionDate":"","surgeryDate":"","comment":"","id":1770548001484,"completed":false},
      {"name":"ë¬¸ì§„ë°°","statuses":["ê³ ë ¤(ì•½ì†ì—†ìŒ)"],"extractionDate":"","surgeryDate":"","comment":"","id":1770548013211,"completed":false},
      {"name":"ì†¡ë‘ì§„","statuses":["ê³ ë ¤(ì•½ì†ì—†ìŒ)"],"extractionDate":"","surgeryDate":"","comment":"","id":1770548024020,"completed":false},
      {"name":"ì„œì¸ìˆ™","statuses":["ìˆ˜ìˆ ì˜ˆì •"],"extractionDate":"2026-02-02","surgeryDate":"","comment":"","id":1770548041571,"completed":false},
      {"name":"ê¹€ì² ì‹","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"2026-01-21","surgeryDate":"2026-01-21","comment":"","id":1770548072739,"completed":false},
      {"name":"ê¹€ì¶˜ì‹","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2026-01-24","comment":"","id":1770548143330,"completed":false},
      {"name":"ë¯¼ë¬¸ê¸°","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2026-01-19","comment":"","id":1770548163634,"completed":false},
      {"name":"ë°•ì°¬ì˜","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2025-09-23","comment":"","id":1770548191140,"completed":false},
      {"name":"ë°•ì¶©ìˆœ","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2026-01-09","comment":"","id":1770548209017,"completed":false},
      {"name":"ë°•í˜œê²½","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"2026-01-16","surgeryDate":"2026-01-16","comment":"","id":1770548233738,"completed":false},
      {"name":"ë°±ì¢…ìš±","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2026-01-23","comment":"","id":1770548262102,"completed":false},
      {"name":"ë°±ì§€ìœ¤","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2025-12-16","comment":"","id":1770548291545,"completed":false},
      {"name":"ì´ì˜¥ì„ ","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2026-01-26","comment":"","id":1770548332050,"completed":false},
      {"name":"ì´ì§€í¬","statuses":["ë¬¸ì œ","ë³´ì² ì˜ˆì •"],"extractionDate":"2025-11-19","surgeryDate":"2025-11-19","comment":"","id":1770548359900,"completed":false},
      {"name":"ì„ë™ì´ˆ","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2026-01-27","comment":"","id":1770548399664,"completed":false},
      {"name":"ì„í˜œìˆ™","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"","surgeryDate":"2026-01-23","comment":"","id":1770548447448,"completed":false},
      {"name":"í™©ì˜¤ìˆ™","statuses":["ë³´ì² ì˜ˆì •"],"extractionDate":"2025-11-12","surgeryDate":"2025-11-12","comment":"","id":1770548482642,"completed":false},
      {"name":"ê°•ë¯¸í¬","statuses":["í¬ë¼ìš´"],"extractionDate":"","surgeryDate":"","comment":"","id":1770548496864,"completed":false},
      {"name":"ë…¸ëª…ìˆ™","statuses":["í¬ë¼ìš´"],"extractionDate":"","surgeryDate":"","comment":"","id":1770548506233,"completed":false},
      {"name":"ë°•í˜œìˆœ","statuses":["í¬ë¼ìš´"],"extractionDate":"","surgeryDate":"","comment":"","id":1770548513506,"completed":false},
      {"name":"ì´í¥ì„­","statuses":["ë¬¸ì œ"],"extractionDate":"","surgeryDate":"2011-05-26","comment":"","id":1770557241015,"completed":false}
    ];

    // ë¡œê·¸ì¸ í•¨ìˆ˜
    function login() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const errorDiv = document.getElementById('authError');
      
      if (!email || !password) {
        errorDiv.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        errorDiv.style.display = 'block';
        return;
      }
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          document.getElementById('authModal').classList.add('hidden');
          document.getElementById('authEmail').value = '';
          document.getElementById('authPassword').value = '';
          errorDiv.style.display = 'none';
          updateAuthUI();
          console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', currentUser.email);
          
          // ë¡œê·¸ì¸ ì„±ê³µ í›„ Firebase ë°ì´í„° ë¡œë“œ
          loadFirebaseData();
        })
        .catch((error) => {
          console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
          errorDiv.textContent = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
          errorDiv.style.display = 'block';
        });
    }

    // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
    function logout() {
      auth.signOut()
        .then(() => {
          currentUser = null;
          updateAuthUI();
          console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
          
          // ë¡œê·¸ì•„ì›ƒ í›„ ì´ˆê¸° ë°ì´í„°ë¡œ ë³µì›
          labPatients = [];
          implantPatients = initialImplantData;
          render();
          
          // ë¡œê·¸ì¸ ëª¨ë‹¬ì€ onAuthStateChangedì—ì„œ ìë™ìœ¼ë¡œ í‘œì‹œë¨
        })
        .catch((error) => {
          console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        });
    }

    // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    function showLoginModal() {
      document.getElementById('authModal').classList.remove('hidden');
    }

    // ì¸ì¦ UI ì—…ë°ì´íŠ¸
    function updateAuthUI() {
      const authStatus = document.getElementById('authStatus');
      const loginButton = document.getElementById('loginButton');
      const userEmail = document.getElementById('userEmail');
      
      if (currentUser) {
        authStatus.classList.remove('hidden');
        loginButton.classList.add('hidden');
        userEmail.textContent = currentUser.email;
      } else {
        authStatus.classList.add('hidden');
        if (useFirebase) {
          loginButton.classList.remove('hidden');
        }
      }
    }

    // Enter í‚¤ë¡œ ë¡œê·¸ì¸
    document.addEventListener('DOMContentLoaded', () => {
      const authEmail = document.getElementById('authEmail');
      const authPassword = document.getElementById('authPassword');
      
      [authEmail, authPassword].forEach(input => {
        input?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            login();
          }
        });
      });
    });

    // Firebase ì´ˆê¸°í™” ì‹œë„
    function initializeFirebase() {
      return new Promise((resolve, reject) => {
        try {
          // â­ Firebase ì„¤ì • ì •ë³´ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
          // Firebase Console â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì¼ë°˜ â†’ ë‚´ ì•± â†’ Firebase SDK snippet â†’ êµ¬ì„±
          const firebaseConfig = {
  apiKey: "AIzaSyDMr4JlL_L7TmOT6r9_W2UDVHVhN6jDSTA",
  authDomain: "bless-dental.firebaseapp.com",
  databaseURL: "https://bless-dental-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bless-dental",
  storageBucket: "bless-dental.firebasestorage.app",
  messagingSenderId: "934691177689",
  appId: "1:934691177689:web:a3c14a31877b1e470beac8"
};
          
          // API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ Firebase ë¹„í™œì„±í™”
          if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.log('âš ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì´ˆê¸° ë°ì´í„°ë¡œ ì‘ë™í•©ë‹ˆë‹¤.');
            reject(new Error('Firebase ì„¤ì • ì—†ìŒ'));
            return;
          }
          
          firebase.initializeApp(firebaseConfig);
          database = firebase.database();
          auth = firebase.auth();
          
          // ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ ì„¤ì • (ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ìœ ì§€)
          auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
              console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ ì„¤ì • ì™„ë£Œ');
            });
          
          console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
          
          // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
          let authCheckCompleted = false;
          auth.onAuthStateChanged((user) => {
            if (user) {
              currentUser = user;
              updateAuthUI();
              console.log('âœ… ì¸ì¦ ìƒíƒœ: ë¡œê·¸ì¸ë¨ -', user.email);
              
              // ìë™ ë¡œê·¸ì¸ ìœ ì§€ ì‹œ Firebase ë°ì´í„° ë¡œë“œ
              loadFirebaseData();
            } else {
              currentUser = null;
              updateAuthUI();
              console.log('â„¹ï¸ ì¸ì¦ ìƒíƒœ: ë¡œê·¸ì•„ì›ƒë¨');
              
              // ì´ˆê¸° ì¸ì¦ í™•ì¸ì´ ì™„ë£Œëœ í›„ì—ë§Œ ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
              // (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¡œê·¸ì¸ ì²´í¬ í›„)
              if (authCheckCompleted && useFirebase) {
                document.getElementById('authModal').classList.remove('hidden');
              }
            }
            
            // ì²« ë²ˆì§¸ ì¸ì¦ ìƒíƒœ í™•ì¸ ì™„ë£Œ
            if (!authCheckCompleted) {
              authCheckCompleted = true;
            }
          });
          
          // Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ (10ì´ˆ íƒ€ì„ì•„ì›ƒ)
          const timeoutId = setTimeout(() => {
            console.log('â±ï¸ ì—°ê²° í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ - ì¼ë‹¨ ì‚¬ìš© ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼');
            clearTimeout(timeoutId);
            useFirebase = true;
            resolve(true);
          }, 10000);
          
          // ë°©ë²• 1: .info/connectedë¡œ í…ŒìŠ¤íŠ¸
          database.ref('.info/connected').once('value')
            .then((snapshot) => {
              clearTimeout(timeoutId);
              if (snapshot.val() === true) {
                console.log('âœ… Firebase ì—°ê²° í™•ì¸ ì™„ë£Œ (.info/connected)');
                useFirebase = true;
                resolve(true);
              } else {
                // ì—°ê²° ì•ˆ ëì–´ë„ ì¼ë‹¨ ì‹œë„
                console.log('âš ï¸ .info/connected = false, í•˜ì§€ë§Œ ê³„ì† ì§„í–‰');
                useFirebase = true;
                resolve(true);
              }
            })
            .catch((error) => {
              clearTimeout(timeoutId);
              console.log('âš ï¸ .info/connected ì²´í¬ ì‹¤íŒ¨, í•˜ì§€ë§Œ FirebaseëŠ” ì‚¬ìš© ê°€ëŠ¥:', error.message);
              // ì´ˆê¸°í™”ëŠ” ì„±ê³µí–ˆìœ¼ë‹ˆ ì‚¬ìš© ê°€ëŠ¥
              useFirebase = true;
              resolve(true);
            });
        } catch (error) {
          console.log('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          reject(error);
        }
      });
    }

    // ë°ì´í„° ë¡œë“œ
    function loadData() {
      initializeFirebase()
        .then(() => {
          // Firebase ì—°ê²° ì„±ê³µ
          console.log('âœ… Firebase ì—°ê²° ì„±ê³µ - ìë™ ë¡œê·¸ì¸ í™•ì¸ ì¤‘');
          
          // ì¼ë‹¨ ì´ˆê¸° ë°ì´í„°ë¡œ ë Œë”ë§ (ë¡œê·¸ì¸ ì „)
          // onAuthStateChangedì—ì„œ ìë™ ë¡œê·¸ì¸ í™•ì¸ í›„ ì²˜ë¦¬
          labPatients = [];
          implantPatients = initialImplantData;
          render();
        })
        .catch((error) => {
          // Firebase ì—°ê²° ì‹¤íŒ¨ - ì´ˆê¸° ë°ì´í„° ì‚¬ìš©
          console.log('âš ï¸ Firebase ì—°ê²° ì‹¤íŒ¨, ì´ˆê¸° ë°ì´í„° ì‚¬ìš©');
          labPatients = [];
          implantPatients = initialImplantData;
          useFirebase = false;
          render();
        });
    }

    // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ (ë¡œê·¸ì¸ í›„ í˜¸ì¶œ)
    function loadFirebaseData() {
      if (!useFirebase || !database || !currentUser) {
        console.log('âš ï¸ Firebase ë°ì´í„° ë¡œë“œ ë¶ˆê°€ (ë¡œê·¸ì¸ í•„ìš”)');
        return;
      }
      
      database.ref('patients').once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          
          if (data) {
            labPatients = data.labPatients || [];
            implantPatients = data.implantPatients || [];
            
            // implantPatientsê°€ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸° ë°ì´í„° ì‚¬ìš©
            if (implantPatients.length === 0) {
              implantPatients = initialImplantData;
              saveData();
            }
            
            console.log('ğŸ“¥ Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
          } else {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸° ë°ì´í„° ì‚¬ìš©
            labPatients = [];
            implantPatients = initialImplantData;
            saveData();
            console.log('ğŸ“¥ ì´ˆê¸° ë°ì´í„° ì‚¬ìš© (Firebase ë°ì´í„° ì—†ìŒ)');
          }
          
          render();
        })
        .catch((error) => {
          console.error('âŒ Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        });
    }

    function saveData() {
      if (useFirebase && database) {
        if (!currentUser) {
          console.log('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë°ì´í„° ì €ì¥ ìƒëµ');
          return;
        }
        
        // Firebaseì— ë°ì´í„° ì €ì¥
        database.ref('patients').set({
          labPatients: labPatients,
          implantPatients: implantPatients
        })
        .then(() => {
          console.log('ğŸ’¾ Firebaseì— ì €ì¥ ì™„ë£Œ');
        })
        .catch((error) => {
          console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
          if (error.code === 'PERMISSION_DENIED') {
            alert('âš ï¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            document.getElementById('authModal').classList.remove('hidden');
          }
        });
      } else {
        console.log('ğŸ’¾ Firebase ë¹„í™œì„±í™” - ì €ì¥ ìƒëµ');
      }
    }

    function resetData() {
      const modal = document.getElementById('confirmModal');
      modal.classList.remove('hidden');
    }

    function closeModal() {
      const modal = document.getElementById('confirmModal');
      modal.classList.add('hidden');
    }

    function confirmReset() {
      // í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
      closeModal();
      
      // ë°ì´í„° ì´ˆê¸°í™”
      labPatients = [];
      implantPatients = initialImplantData;
      saveData();
      render();
      
      // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
      const successMsg = document.getElementById('successMessage');
      successMsg.classList.remove('hidden');
      
      // 2ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«ê¸°
      setTimeout(() => {
        closeSuccessMessage();
      }, 2000);
    }

    function closeSuccessMessage() {
      const successMsg = document.getElementById('successMessage');
      successMsg.classList.add('hidden');
    }

    // ë‚ ì§œ ê³„ì‚°
    function calculateDaysLeft(deadline) {
      if (!deadline) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const deadlineDate = new Date(deadline);
      deadlineDate.setHours(0, 0, 0, 0);
      const diffTime = deadlineDate - today;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function calculateDaysSince(date) {
      if (!date) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const targetDate = new Date(date);
      targetDate.setHours(0, 0, 0, 0);
      const diffTime = today - targetDate;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function daysLeftColor(days) {
      if (days === null) return '#94a3b8';
      if (days < 0) return '#ef4444';
      if (days <= 2) return '#f59e0b';
      return '#10b981';
    }

    // ê¸°ê³µì†Œ ê´€ë ¨ í•¨ìˆ˜
    function toggleLabForm() {
      const form = document.getElementById('labForm');
      form.classList.toggle('hidden');
    }

    function addLabPatient() {
      const name = document.getElementById('labName').value;
      const work = document.getElementById('labWork').value;
      const receiveDate = document.getElementById('labReceiveDate').value;
      const deadline = document.getElementById('labDeadline').value;

      if (!name || !work) {
        return; // í•„ìˆ˜ ì…ë ¥ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ê·¸ëƒ¥ ë¦¬í„´
      }

      labPatients.push({
        id: Date.now(),
        name,
        work,
        receiveDate,
        deadline,
        completed: false
      });

      // í¼ ì´ˆê¸°í™”
      document.getElementById('labName').value = '';
      document.getElementById('labWork').value = '';
      document.getElementById('labReceiveDate').value = '';
      document.getElementById('labDeadline').value = '';
      toggleLabForm();

      saveData();
      render();
    }

    function updateLabField(id, field, value) {
      const patient = labPatients.find(p => p.id === id);
      if (patient) {
        patient[field] = value;
        saveData();
        render();
      }
    }

    function toggleLabComplete(id) {
      const patient = labPatients.find(p => p.id === id);
      if (patient) {
        patient.completed = !patient.completed;
        saveData();
        render();
      }
    }

    function deleteLabPatient(id) {
      labPatients = labPatients.filter(p => p.id !== id);
      saveData();
      render();
    }

    // ì„í”Œë€íŠ¸ ê´€ë ¨ í•¨ìˆ˜
    function toggleImplantForm() {
      const form = document.getElementById('implantForm');
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        formStatuses = [];
        renderFormStatuses();
      }
    }

    function addFormStatus(status) {
      if (status && !formStatuses.includes(status)) {
        formStatuses.push(status);
        renderFormStatuses();
      }
    }

    function removeFormStatus(status) {
      formStatuses = formStatuses.filter(s => s !== status);
      renderFormStatuses();
    }

    function renderFormStatuses() {
      const container = document.getElementById('implantFormStatuses');
      if (!container) return;
      
      container.innerHTML = formStatuses.map(status => `
        <span class="status-badge" style="background-color: ${statusColors[status]}">
          ${status}
          <button class="status-remove" onclick="removeFormStatus('${status}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6 6 18M6 6l12 12"/>
            </svg>
          </button>
        </span>
      `).join('');
    }

    function addImplantPatient() {
      const name = document.getElementById('implantName').value;
      const comment = document.getElementById('implantComment').value;
      const extractionDate = document.getElementById('implantExtractionDate').value;
      const surgeryDate = document.getElementById('implantSurgeryDate').value;

      if (!name) {
        return; // í•„ìˆ˜ ì…ë ¥ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ê·¸ëƒ¥ ë¦¬í„´
      }

      implantPatients.push({
        id: Date.now(),
        name,
        comment,
        extractionDate,
        surgeryDate,
        statuses: [...formStatuses], // í¼ì—ì„œ ì„ íƒí•œ ìƒíƒœë“¤ í¬í•¨
        completed: false
      });

      // í¼ì—ì„œ "ê¸°ê³µì†Œ" ìƒíƒœë¥¼ ì„ íƒí–ˆìœ¼ë©´ ê¸°ê³µì†Œ ë¦¬ìŠ¤íŠ¸ì—ë„ ì¶”ê°€
      if (formStatuses.includes('ê¸°ê³µì†Œ')) {
        const existingLabPatient = labPatients.find(p => p.name === name);
        if (!existingLabPatient) {
          labPatients.push({
            id: Date.now() + 1, // ì•½ê°„ ë‹¤ë¥¸ ID
            name,
            work: 'ì„í”Œë€íŠ¸',
            receiveDate: new Date().toISOString().split('T')[0],
            deadline: '',
            completed: false
          });
        }
      }

      // í¼ ì´ˆê¸°í™”
      document.getElementById('implantName').value = '';
      document.getElementById('implantComment').value = '';
      document.getElementById('implantExtractionDate').value = '';
      document.getElementById('implantSurgeryDate').value = '';
      formStatuses = [];
      renderFormStatuses();
      toggleImplantForm();

      saveData();
      render();
    }

    function updateImplantDate(id, field, value) {
      const patient = implantPatients.find(p => p.id === id);
      if (patient) {
        patient[field] = value;
        saveData();
        render();
      }
    }

    function updateImplantComment(id, value) {
      const patient = implantPatients.find(p => p.id === id);
      if (patient) {
        patient.comment = value;
        saveData();
        render();
      }
    }

    function toggleImplantComplete(id) {
      const patient = implantPatients.find(p => p.id === id);
      if (patient) {
        patient.completed = !patient.completed;
        saveData();
        render();
      }
    }

    function deleteImplantPatient(id) {
      implantPatients = implantPatients.filter(p => p.id !== id);
      saveData();
      render();
    }

    function addImplantStatus(id, status) {
      const patient = implantPatients.find(p => p.id === id);
      if (patient && !patient.statuses.includes(status)) {
        patient.statuses.push(status);
        
        // "ê¸°ê³µì†Œ" ìƒíƒœê°€ ì¶”ê°€ë˜ë©´ ê¸°ê³µì†Œ ë¦¬ìŠ¤íŠ¸ì—ë„ ì¶”ê°€
        if (status === 'ê¸°ê³µì†Œ') {
          const existingLabPatient = labPatients.find(p => p.name === patient.name);
          if (!existingLabPatient) {
            labPatients.push({
              id: Date.now(),
              name: patient.name,
              work: 'ì„í”Œë€íŠ¸', // ê¸°ë³¸ ì‘ì—…ë‚´ìš©
              receiveDate: new Date().toISOString().split('T')[0], // ì˜¤ëŠ˜ ë‚ ì§œ
              deadline: '',
              completed: false
            });
          }
        }
        
        saveData();
        render();
      }
    }

    let pendingLabRemoval = null; // ì‚­ì œ ëŒ€ê¸° ì¤‘ì¸ ê¸°ê³µì†Œ í™˜ì ì •ë³´

    function toggleStatusGroup(statusName) {
      collapsedGroups[statusName] = !collapsedGroups[statusName];
      render();
    }

    function removeImplantStatus(id, status) {
      const patient = implantPatients.find(p => p.id === id);
      if (!patient) return;
      
      // "ê¸°ê³µì†Œ" ìƒíƒœë¥¼ ì œê±°í•˜ëŠ” ê²½ìš°
      if (status === 'ê¸°ê³µì†Œ') {
        const labPatient = labPatients.find(p => p.name === patient.name);
        if (labPatient) {
          // ëª¨ë‹¬ í‘œì‹œ
          pendingLabRemoval = { implantId: id, status, labPatient };
          document.getElementById('labRemovalMessage').textContent = 
            `"${patient.name}" í™˜ìë¥¼ ê¸°ê³µì†Œ ì‘ì—… í˜„í™© ë¦¬ìŠ¤íŠ¸ì—ì„œë„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
          document.getElementById('labRemovalModal').classList.remove('hidden');
          return;
        }
      }
      
      // ì¼ë°˜ ìƒíƒœ ì œê±°
      patient.statuses = patient.statuses.filter(s => s !== status);
      saveData();
      render();
    }

    function closeLabRemovalModal() {
      document.getElementById('labRemovalModal').classList.add('hidden');
      pendingLabRemoval = null;
    }

    function confirmLabRemoval() {
      if (pendingLabRemoval) {
        const { implantId, status, labPatient } = pendingLabRemoval;
        const patient = implantPatients.find(p => p.id === implantId);
        
        // ì„í”Œë€íŠ¸ì—ì„œ ê¸°ê³µì†Œ ìƒíƒœ ì œê±°
        if (patient) {
          patient.statuses = patient.statuses.filter(s => s !== status);
        }
        
        // ê¸°ê³µì†Œ ë¦¬ìŠ¤íŠ¸ì—ì„œë„ ì‚­ì œ
        labPatients = labPatients.filter(p => p.id !== labPatient.id);
        
        saveData();
        render();
      }
      closeLabRemovalModal();
    }

    // ë Œë”ë§
    function render() {
      // í•„í„°ë§
      const filteredLab = labPatients.filter(p =>
        p.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        p.work?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const filteredImplant = implantPatients.filter(p =>
        p.name?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      // í†µê³„ ì—…ë°ì´íŠ¸
      document.getElementById('totalPatients').textContent = labPatients.length + implantPatients.length;
      document.getElementById('labCount').textContent = labPatients.length;
      document.getElementById('implantCount').textContent = implantPatients.length;
      document.getElementById('labFilteredCount').textContent = filteredLab.length;
      document.getElementById('implantFilteredCount').textContent = filteredImplant.length;

      // ê¸°ê³µì†Œ í…Œì´ë¸” ë Œë”ë§
      const labTableBody = document.getElementById('labTableBody');
      labTableBody.innerHTML = filteredLab.map(patient => {
        const daysLeft = calculateDaysLeft(patient.deadline);
        const daysText = daysLeft !== null
          ? (daysLeft > 0 ? `D-${daysLeft}` : daysLeft === 0 ? 'D-Day' : `+${Math.abs(daysLeft)}`)
          : '';
        
        return `
          <tr class="${patient.completed ? 'completed' : ''}">
            <td style="font-weight: bold;">
              ${patient.name}
            </td>
            <td>
              <input type="text" value="${patient.work}" 
                onchange="updateLabField(${patient.id}, 'work', this.value)">
            </td>
            <td>
              <input type="date" value="${patient.receiveDate || ''}" 
                class="${patient.receiveDate ? 'has-value' : ''}"
                onchange="updateLabField(${patient.id}, 'receiveDate', this.value)">
            </td>
            <td>
              <input type="date" value="${patient.deadline || ''}" 
                class="${patient.deadline ? 'has-value' : ''}"
                onchange="updateLabField(${patient.id}, 'deadline', this.value)">
            </td>
            <td style="text-align: center;">
              ${daysLeft !== null ? `<span class="badge" style="background-color: ${daysLeftColor(daysLeft)}">${daysText}</span>` : ''}
            </td>
            <td style="text-align: center;">
              <input type="checkbox" ${patient.completed ? 'checked' : ''} 
                onchange="toggleLabComplete(${patient.id})">
            </td>
            <td style="text-align: center;">
              <button class="btn-delete" onclick="deleteLabPatient(${patient.id})">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      // ì„í”Œë€íŠ¸ í…Œì´ë¸” ë Œë”ë§
      const implantTableBody = document.getElementById('implantTableBody');
      
      // ìƒíƒœ ìš°ì„ ìˆœìœ„ ì •ì˜ (ì¼ë°˜ ìƒíƒœìš©)
      const statusPriority = {
        'ë¬¸ì œ': 0,
        'ê³ ë ¤(ì•½ì†ì—†ìŒ)': 1,
        'ì¶”ê°€ì—°ë½': 2,
        'ê³ ë ¤(ì•½ì†ìˆìŒ)': 3,
        'ìˆ˜ìˆ ì˜ˆì •': 4,
        'ë³´ì² ì˜ˆì •': 5,
        'ë³´ì²  ì¥ì°©': 6,
        'ë³´ì¡´': 7,
        'ì—”ë„': 8,
        'í˜ë¦¬ì˜¤': 9,
        'í¬ë¼ìš´': 10,
        'ê¸°ê³µì†Œ': 11,
        'ì™„ë£Œ': 12
      };
      
      const statusNames = ['ë¬¸ì œ', 'ê³ ë ¤(ì•½ì†ì—†ìŒ)', 'ì¶”ê°€ì—°ë½', 'ê³ ë ¤(ì•½ì†ìˆìŒ)', 'ìˆ˜ìˆ ì˜ˆì •', 'ë³´ì² ì˜ˆì •', 'ë³´ì²  ì¥ì°©', 'ë³´ì¡´', 'ì—”ë„', 'í˜ë¦¬ì˜¤', 'í¬ë¼ìš´', 'ê¸°ê³µì†Œ', 'ì™„ë£Œ', 'ìƒíƒœì—†ìŒ'];
      
      // í™˜ìì˜ ê°€ì¥ ë†’ì€ ìš°ì„ ìˆœìœ„ ìƒíƒœ ì°¾ê¸°
      const getTopPriority = (patient) => {
        if (!patient.statuses || patient.statuses.length === 0) return 999;
        const priorities = patient.statuses.map(s => statusPriority[s] ?? 999);
        return Math.min(...priorities);
      };
      
      // í™˜ìì˜ ì£¼ìš” ìƒíƒœ ì´ë¦„ ì°¾ê¸°
      const getTopStatusName = (patient) => {
        if (!patient.statuses || patient.statuses.length === 0) return 'ìƒíƒœì—†ìŒ';
        
        // ì™„ë£Œ ìƒíƒœê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì™„ë£Œ ì¹´í…Œê³ ë¦¬ë¡œ
        if (patient.statuses.includes('ì™„ë£Œ')) return 'ì™„ë£Œ';
        
        const topPriority = getTopPriority(patient);
        return statusNames.find(s => statusPriority[s] === topPriority) || 'ìƒíƒœì—†ìŒ';
      };
      
      // ì™„ë£Œ ìƒíƒœ í™•ì¸
      const isCompleted = (patient) => patient.statuses && patient.statuses.includes('ì™„ë£Œ');
      
      // ì™„ë£Œ/ì¼ë°˜ í™˜ì ë¶„ë¦¬
      const activePatients = filteredImplant.filter(p => !isCompleted(p));
      const completedPatients = filteredImplant.filter(p => isCompleted(p));
      
      // ìƒíƒœë³„ë¡œ ê·¸ë£¹í™”
      const groupByStatus = (patients) => {
        const groups = {};
        patients.forEach(patient => {
          const status = getTopStatusName(patient);
          if (!groups[status]) groups[status] = [];
          groups[status].push(patient);
        });
        
        // ê° ê·¸ë£¹ ë‚´ì—ì„œ ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
        Object.keys(groups).forEach(status => {
          groups[status].sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        });
        
        return groups;
      };
      
      const activeGroups = groupByStatus(activePatients);
      const completedGroups = groupByStatus(completedPatients);
      
      const renderPatient = (patient, completed) => {
        const availableStatuses = statusOptions.filter(s => !patient.statuses.includes(s));
        const patientCategory = getTopStatusName(patient);
        const daysSinceSurgery = calculateDaysSince(patient.surgeryDate);
        const daysSinceExtraction = calculateDaysSince(patient.extractionDate);
        const showSurgeryDays = patientCategory === 'ë³´ì² ì˜ˆì •' && daysSinceSurgery !== null;
        const showExtractionDays = patientCategory === 'ìˆ˜ìˆ ì˜ˆì •' && daysSinceExtraction !== null;
        
        return `
          <tr class="implant ${completed ? 'completed' : ''}">
            <td style="font-weight: bold; padding-left: 2rem;">${patient.name}</td>
            <td>
              <div class="status-container">
                ${patient.statuses && patient.statuses.length > 0 ? `
                  ${patient.statuses.map(status => `
                    <span class="status-badge" style="background-color: ${statusColors[status]}">
                      ${status}
                      <button class="status-remove" onclick="removeImplantStatus(${patient.id}, '${status}')">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M18 6 6 18M6 6l12 12"/>
                        </svg>
                      </button>
                    </span>
                  `).join('')}
                ` : '<span style="color: #94a3b8; font-size: 0.75rem;">ìƒíƒœ ì—†ìŒ</span>'}
                ${availableStatuses.length > 0 ? `
                  <select class="status-select" onchange="if(this.value) { addImplantStatus(${patient.id}, this.value); this.value = ''; }">
                    <option value="">+ ìƒíƒœ ì¶”ê°€</option>
                    ${availableStatuses.map(status => `<option value="${status}">${status}</option>`).join('')}
                  </select>
                ` : ''}
              </div>
            </td>
            <td>
              <input type="text" value="${patient.comment || ''}" 
                onchange="updateImplantComment(${patient.id}, this.value)"
                placeholder=""
                style="width: 100%; padding: 0.375rem 0.75rem; border-radius: 0.5rem; border: 1px solid transparent; background: transparent; outline: none; transition: all 0.2s ease;">
            </td>
            <td>
              <div style="position: relative; display: inline-block; width: 100%;">
                <input type="date" value="${patient.extractionDate || ''}" 
                  class="${patient.extractionDate ? 'has-value' : ''}"
                  onchange="updateImplantDate(${patient.id}, 'extractionDate', this.value)"
                  style="width: 100%;">
                ${showExtractionDays ? `<span style="position: absolute; right: 2rem; top: 50%; transform: translateY(-50%); color: #06b6d4; font-size: 0.7rem; font-weight: 600; pointer-events: none; white-space: nowrap;">[+${daysSinceExtraction}ì¼]</span>` : ''}
              </div>
            </td>
            <td>
              <div style="position: relative; display: inline-block; width: 100%;">
                <input type="date" value="${patient.surgeryDate || ''}" 
                  class="${patient.surgeryDate ? 'has-value' : ''}"
                  onchange="updateImplantDate(${patient.id}, 'surgeryDate', this.value)"
                  style="width: 100%;">
                ${showSurgeryDays ? `<span style="position: absolute; right: 2rem; top: 50%; transform: translateY(-50%); color: #8b5cf6; font-size: 0.7rem; font-weight: 600; pointer-events: none; white-space: nowrap;">[+${daysSinceSurgery}ì¼]</span>` : ''}
              </div>
            </td>
            <td style="text-align: center;">
              <button class="btn-delete" onclick="deleteImplantPatient(${patient.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </td>
          </tr>
        `;
      };
      
      const renderGroupHeader = (statusName, count) => {
        const isCollapsed = collapsedGroups[statusName];
        const icon = isCollapsed ? 'â–¶' : 'â–¼';
        const bgColor = statusColors[statusName] || '#94a3b8';
        
        return `
          <tr class="group-header" style="background: linear-gradient(to right, ${bgColor}20, ${bgColor}10); cursor: pointer;" onclick="toggleStatusGroup('${statusName}')">
            <td colspan="6" style="padding: 0.5rem 1rem; font-weight: bold; color: #1e293b;">
              <span style="display: inline-block; width: 1rem; font-size: 0.75rem;">${icon}</span>
              <span style="color: ${bgColor};">${statusName}</span>
              <span style="color: #64748b; font-size: 0.75rem; margin-left: 0.5rem;">(${count}ëª…)</span>
            </td>
          </tr>
        `;
      };
      
      let html = '';
      
      // í™œì„± í™˜ìë“¤ (ìƒíƒœë³„ ê·¸ë£¹) - ì¶”ê°€ì—°ë½ í¬í•¨
      statusNames.forEach(statusName => {
        if (statusName !== 'ì™„ë£Œ' && activeGroups[statusName] && activeGroups[statusName].length > 0) {
          const patients = activeGroups[statusName];
          html += renderGroupHeader(statusName, patients.length);
          
          if (!collapsedGroups[statusName]) {
            html += patients.map(p => renderPatient(p, false)).join('');
          }
        }
      });
      
      // êµ¬ë¶„ì„  (ì™„ë£Œëœ í™˜ìê°€ ìˆì„ ë•Œ)
      if (Object.keys(completedGroups).length > 0 && Object.keys(activeGroups).length > 0) {
        html += `
          <tr style="height: 4px; background: linear-gradient(to right, #14b8a6, #10b981);">
            <td colspan="6" style="padding: 0; height: 4px;"></td>
          </tr>
        `;
      }
      
      // ì™„ë£Œ ìƒíƒœê°€ ìˆëŠ” í™˜ìë“¤
      if (completedGroups['ì™„ë£Œ'] && completedGroups['ì™„ë£Œ'].length > 0) {
        const patients = completedGroups['ì™„ë£Œ'];
        html += renderGroupHeader('ì™„ë£Œ', patients.length);
        
        if (!collapsedGroups['ì™„ë£Œ']) {
          html += patients.map(p => renderPatient(p, true)).join('');
        }
      }
      
      implantTableBody.innerHTML = html;
    }

    // ê²€ìƒ‰
    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchTerm = e.target.value;
      render();
    });

    // ì´ˆê¸°í™”
    window.addEventListener('load', () => {
      loadData();
    });
  </script>
</body>
</html>
